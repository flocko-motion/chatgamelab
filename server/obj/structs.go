package obj

import (
	"time"

	"github.com/google/uuid"
)

type Meta struct {
	CreatedBy  uuid.NullUUID `json:"createdBy"`
	CreatedAt  *time.Time    `json:"createdAt"`
	ModifiedBy uuid.NullUUID `json:"modifiedBy"`
	ModifiedAt *time.Time    `json:"modifiedAt"`
}

type User struct {
	ID        uuid.UUID     `json:"id"`
	Meta      Meta          `json:"meta"`
	Name      string        `json:"name"`
	Email     *string       `json:"email"`
	DeletedAt *time.Time    `json:"deletedAt"`
	Auth0Id   *string       `json:"auth0Id"`
	Role      *UserRole     `json:"role"`
	ApiKeys   []ApiKeyShare `json:"apiKeys"`
}

type Institution struct {
	ID   uuid.UUID `json:"id"`
	Meta Meta      `json:"meta"`
	Name string    `json:"name"`
}

type Role string

const (
	RoleAdmin Role = "admin"
	RoleHead  Role = "head"
	RoleStaff Role = "staff"
)

type UserRole struct {
	ID          uuid.UUID    `json:"id"`
	Meta        Meta         `json:"meta"`
	UserID      uuid.UUID    `json:"userId"`
	Role        Role         `json:"role"`
	Institution *Institution `json:"institution"`
}

type Workshop struct {
	ID           uuid.UUID             `json:"id"`
	Meta         Meta                  `json:"meta"`
	Name         string                `json:"name"`
	Institution  *Institution          `json:"institution"`
	Active       bool                  `json:"active"`
	Public       bool                  `json:"public"`
	Participants []WorkshopParticipant `json:"participants,omitempty"`
}

type WorkshopParticipant struct {
	ID          uuid.UUID `json:"id"`
	Meta        Meta      `json:"meta"`
	WorkshopID  uuid.UUID `json:"workshopId"`
	Name        string    `json:"name"`
	AccessToken string    `json:"accessToken"`
	Active      bool      `json:"active"`
}

type ApiKey struct {
	ID           uuid.UUID `json:"id"`
	Meta         Meta      `json:"meta"`
	UserID       uuid.UUID `json:"userId"`
	Platform     string    `json:"platform"`
	Key          string    `json:"-"`
	KeyShortened string    `json:"keyShortened"`
}

// userID of owner is stored in createdBy
type ApiKeyShare struct {
	ID                        uuid.UUID  `json:"id"`
	Meta                      Meta       `json:"meta"`
	ApiKey                    *ApiKey    `json:"apiKey"`
	UserID                    *uuid.UUID `json:"userId"`
	WorkshopID                *uuid.UUID `json:"workshopId"`
	AllowPublicSponsoredPlays bool       `json:"allowPublicSponsoredPlays"`
}

type Game struct {
	ID          uuid.UUID `json:"id" yaml:"id,omitempty"`
	Meta        Meta      `json:"meta" yaml:"-"`
	Name        string    `json:"name" yaml:"name"`
	Description *string   `json:"description" yaml:"description,omitempty"`
	Icon        []byte    `json:"icon" yaml:"-"`
	// Access rights and payments. public = true: discoverable on the website and playable by anyone.
	Public bool `json:"public" yaml:"-"`
	// If public, a sponsored API key can be provided to pay for any public plays.
	PublicSponsoredApiKeyID *uuid.UUID `json:"publicSponsoredApiKeyId" yaml:"-"`
	// Private share links contain secret random tokens to limit access to the game.
	// They are sponsored, so invited players don't require their own API key.
	PrivateShareHash         *string    `json:"privateShareHash" yaml:"-"`
	PrivateSponsoredApiKeyID *uuid.UUID `json:"privateSponsoredApiKeyId" yaml:"-"`
	// Game details and system messages for the LLM.
	// What is the game about? How does it work? Player role? World description?
	SystemMessageScenario string `json:"systemMessageScenario" yaml:"system_message_scenario,omitempty"`
	// How should the game start? First scene? How is the player welcomed?
	SystemMessageGameStart string `json:"systemMessageGameStart" yaml:"system_message_game_start,omitempty"`
	// What style should the images have?
	ImageStyle string `json:"imageStyle" yaml:"image_style,omitempty"`
	// Additional CSS for the game, probably generated by the LLM.
	// Should be validated/parsed strictly to avoid arbitrary code execution.
	CSS *string `json:"css" yaml:"css,omitempty"`
	// The status fields available to the LLM, shaping the JSON format for status.
	StatusFields string `json:"statusFields" yaml:"status_fields,omitempty"`
	// Quick start: pre-generated first scene of the game.
	// This is generated content (first output after the system message) and may be
	// regenerated from time to time to avoid being too static.
	FirstMessage *string   `json:"firstMessage" yaml:"first_message,omitempty"`
	FirstStatus  *string   `json:"firstStatus" yaml:"first_status,omitempty"`
	FirstImage   []byte    `json:"firstImage" yaml:"-"`
	Tags         []GameTag `json:"tags" yaml:"-"`
}

type GameTag struct {
	ID     uuid.UUID `json:"id"`
	Meta   Meta      `json:"meta"`
	GameID uuid.UUID `json:"gameId"`
	Tag    string    `json:"tag"`
}

// GameSession
// A session is created when a user plays a game -> it's the instance of a game.
type GameSession struct {
	ID   uuid.UUID `json:"id"`
	Meta Meta      `json:"meta"`

	GameID          uuid.UUID `json:"gameId"`
	GameName        string    `json:"gameName"`
	GameDescription string    `json:"gameDescription"`
	UserID          uuid.UUID `json:"userId"`
	UserName        string    `json:"userName"`
	// API key used to pay for this session (sponsored or user-owned), implicitly defines platform.
	ApiKeyID uuid.UUID `json:"apiKeyId"`
	// AI model used for playing.
	Model string `json:"model"`
	// JSON with arbitrary details to be used within that model and within that session.
	ModelSession string `json:"modelSession"`
	ImageStyle   string `json:"imageStyle"`
	// Defines the status fields available in the game; copied from game.status_fields at launch.
	StatusFields []StatusField `json:"statusFields"`
}

type StatusField struct {
	Name  string `json:"name"`
	Value string `json:"value"`
}

type GameSessionMessage struct {
	ID   uuid.UUID `json:"id"`
	Meta Meta      `json:"meta"`

	GameSessionID uuid.UUID `json:"gameSessionId"`
	// player: user message; game: LLM/game response; system: initial system/context messages.
	Type string `json:"type"`
	// Plain text of the scene (system message, player action, or game response).
	Message string `json:"message"`
	// JSON encoded status fields.
	StatusFields []StatusField `json:"statusFields"`
	ImagePrompt  *string       `json:"imagePrompt"`
	Image        []byte        `json:"image"`
}

// ----------------LEGACY TYPES-----------------------
const GameInputTypeAction = "player-action"
const GameInputTypeIntro = "intro"
const GameOutputTypeError = "error"
const GameOutputTypeStory = "story"

// ----------------LEGACY TYPES-----------------------
type GameActionInput struct {
	ChapterId uint          `json:"-"`
	Type      string        `json:"type"`
	Message   string        `json:"action"`
	Status    []StatusField `json:"status"`
}

// ----------------LEGACY TYPES-----------------------
type GameActionOutputGpt struct {
	ChapterId   uint          `json:"chapterId"`
	SessionHash string        `json:"sessionHash"`
	Type        string        `json:"type"`
	Story       string        `json:"story"`
	Status      []StatusField `json:"status"`
	Image       string        `json:"image"`
}

// ----------------LEGACY TYPES-----------------------
type GameActionOutput struct {
	ChapterId             uint          `json:"chapterId"`
	SessionHash           string        `json:"sessionHash"`
	Type                  string        `json:"type"`
	Story                 string        `json:"story"`
	Status                []StatusField `json:"status"`
	Image                 string        `json:"image"`
	Error                 string        `json:"error"`
	RawInput              string        `json:"rawInput"`
	RawOutput             string        `json:"rawOutput"`
	AssistantInstructions string        `json:"assistantInstructions"`
	Agent                 AgentInfo     `json:"agent"`
}

// ----------------LEGACY TYPES-----------------------
type AgentInfo struct {
	Key             string `json:"key"`
	Model           string `json:"model"`
	Assistant       string `json:"assistant"`
	Thread          string `json:"thread"`
	ComputationTime string `json:"computationTime"`
}
